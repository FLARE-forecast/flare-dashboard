---
title: "National Ecological Observatory Network"
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

```{r setup}
library(ggiraph)
library(patchwork)
library(tidyverse)
library(neon4cast)
library(score4cast)


library(thematic)
thematic_rmd(bg="white", fg="black", accent="blue")

#source("R/plot-utils.R")


```

## Most recent forecasts

The National Ecological Observatory Network (NEON) is a U.S. National Science Foundation funded project to monitor 81 ecosystems across the U.S. using standardized measurements over the next 30 years.  We generate forecast for the seven lakes that are monitored by NEON.  These lakes range from hot humid (Florida) to cold tundra (Alaska) environments.

::: panel-tabset

## Barco Lake

```{r}
s3 <- arrow::s3_bucket(bucket = "scores/parquet", endpoint_override = "s3.flare-forecast.org", anonymous = TRUE)

most_recent <-  arrow::open_dataset(s3) |> 
  filter(site_id %in% c("BARC")) |> 
  summarize(max = max(reference_datetime)) |> 
  collect() |> 
  pull()

df_insitu_scores <- arrow::open_dataset(s3) |> 
  filter(variable == "temperature",
         depth %in% c(0.5),
         site_id %in% c("BARC"),
         reference_datetime == most_recent) |> 
  dplyr::collect()
```

The most recent forecast is from `r lubridate::with_tz(lubridate::as_datetime(most_recent), tzone = "America/New_York")`  (Eastern U.S. time).

```{r}
## date of each team's most recent forecast

df_insitu_scores_lake <- df_insitu_scores |> 
  filter(site_id == "BARC")
my_breaks <- lubridate::with_tz(seq(min(df_insitu_scores_lake$datetime), max(df_insitu_scores_lake$datetime), by = "1 day"),"America/New_York")   
my_label <- seq(lubridate::as_datetime(df_insitu_scores_lake$reference_datetime)[1], max(df_insitu_scores_lake$datetime), by = "5 days")
my_labels <- as.character(my_breaks)
my_labels[which(!(my_breaks %in% my_label))] <- " "

y_label <- expression(paste('Water temperature (',degree,'C)', sep = ""))
df_insitu_scores_lake |> 
  dplyr::mutate(datetime = lubridate::with_tz(lubridate::as_datetime(datetime), "America/New_York"),
                reference_datetime = lubridate::with_tz(lubridate::as_datetime(reference_datetime), "America/New_York"),
                depth = paste0("Depth: ", depth)) |> 
  ggplot(aes(x = datetime)) +
  geom_ribbon(aes(ymin = quantile10, ymax = quantile90), fill = "lightblue", color = "lightblue") +
  geom_line(aes(y = mean)) +
  geom_point(aes(y = observation)) +
  geom_vline(aes(xintercept = reference_datetime)) +
  scale_x_continuous(breaks = my_breaks, labels = my_labels) +
  facet_wrap(~depth) +
  labs(y = y_label) +
  ylim(c(-5,35)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.2)) +
  theme(text = element_text(size = 20))  
```

## Crampton Lake

Pending

```{r}

```

## Little Rock Lake

Pending

```{r}

```

## Prairie Lake

Pending

```{r}

```

## Prairie Pothole

Pending

```{r}

```

## Suggs Lake


```{r}
s3 <- arrow::s3_bucket(bucket = "scores/parquet", endpoint_override = "s3.flare-forecast.org", anonymous = TRUE)

most_recent <-  arrow::open_dataset(s3) |> 
  filter(site_id %in% c("SUGG")) |> 
  summarize(max = max(reference_datetime)) |> 
  collect() |> 
  pull()

df_insitu_scores <- arrow::open_dataset(s3) |> 
  filter(variable == "temperature",
         depth %in% c(0.5),
         site_id %in% c("SUGG"),
         reference_datetime == most_recent) |> 
  dplyr::collect()
```

The most recent forecast is from `r lubridate::with_tz(lubridate::as_datetime(most_recent), tzone = "America/New_York")`  (Eastern U.S. time).

```{r}
## date of each team's most recent forecast
df_insitu_scores_lake <- df_insitu_scores |> 
  filter(site_id == "SUGG")
my_breaks <- lubridate::with_tz(seq(min(df_insitu_scores_lake$datetime), max(df_insitu_scores_lake$datetime), by = "1 day"),"America/New_York")   
my_label <- seq(lubridate::as_datetime(df_insitu_scores_lake$reference_datetime)[1], max(df_insitu_scores_lake$datetime), by = "5 days")
my_labels <- as.character(my_breaks)
my_labels[which(!(my_breaks %in% my_label))] <- " "

y_label <- expression(paste('Water temperature (',degree,'C)', sep = ""))
df_insitu_scores_lake |> 
  dplyr::mutate(datetime = lubridate::with_tz(lubridate::as_datetime(datetime), "America/New_York"),
                reference_datetime = lubridate::with_tz(lubridate::as_datetime(reference_datetime), "America/New_York"),
                depth = paste0("Depth: ", depth)) |> 
  ggplot(aes(x = datetime)) +
  geom_ribbon(aes(ymin = quantile10, ymax = quantile90), fill = "lightblue", color = "lightblue") +
  geom_line(aes(y = mean)) +
  geom_point(aes(y = observation)) +
  geom_vline(aes(xintercept = reference_datetime)) +
  scale_x_continuous(breaks = my_breaks, labels = my_labels) +
  facet_wrap(~depth) +
  labs(y = y_label) +
  ylim(c(-5,35)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.2)) +
  theme(text = element_text(size = 20))
```

:::
