---
title: "Lake Sunapee Protective Association"
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

```{r setup}
library(ggiraph)
library(patchwork)
library(tidyverse)
library(neon4cast)
library(score4cast)


library(thematic)
thematic_rmd(bg="white", fg="black", accent="blue")

source("R/flare-plots.R")


```

## Most recent forecasts

Below are forecasts for Lake Sunapee, NH. Lake Sunapee is the fifth largest lake in New Hampshire. The forecasts are for the location of the bouy that is maintained by the Lake Sunapee Protective Association.

::: panel-tabset
## Lake Sunapee

```{r}
# s3 <- arrow::s3_bucket(bucket = "scores/parquet", endpoint_override = "s3.flare-forecast.org", anonymous = TRUE)
# 
# most_recent <-  arrow::open_dataset(s3) |> 
#   filter(site_id == "sunp") |> 
#   summarize(max = max(reference_datetime)) |> 
#   collect() |> 
#   pull()
# 
# df_insitu_scores <- arrow::open_dataset(s3) |> 
#   filter(variable == "temperature",
#          depth %in% c(1.0, 8.0),
#          site_id == "sunp",
#          reference_datetime == most_recent) |> 
#   dplyr::collect()

s3_score <- arrow::s3_bucket(bucket = "scores/parquet", endpoint_override = "s3.flare-forecast.org", anonymous = TRUE)
s3_forecast <- arrow::s3_bucket(bucket = "forecasts/parquet", endpoint_override = "s3.flare-forecast.org", anonymous = TRUE)
  
most_recent <-  arrow::open_dataset(s3_score) |> 
  filter(site_id %in% c("sunp")) |> 
  summarize(max = max(reference_datetime)) |> 
  collect() |> 
  pull()

df_insitu_scores <- arrow::open_dataset(s3_score) |> 
  filter(variable == "temperature",
         # depth %in% c(0.5),
         site_id %in% c("sunp"),
         reference_datetime == most_recent) |> 
  dplyr::collect()
```

The most recent forecast is from `r lubridate::with_tz(lubridate::as_datetime(most_recent), tzone = "America/New_York")` (Eastern U.S. time).

```{r sunp-temp}
df_insitu_scores_lake <- df_insitu_scores |> 
  filter(site_id == "sunp")

plot_temp(df_insitu_scores_lake, depths = c(1,8)) 
```

```{r sunp-error, eval = FALSE}
df_horizon <- arrow::open_dataset(s3) |> 
  filter(variable == "temperature",
         site_id == "sunp",
         depth %in% c(1.0, 8.0),
         horizon %in% c(2,7,14)) |> 
  dplyr::collect()

df_horizon |> 
  ggplot(aes(x = observation, y = mean, color = horizon)) +
  geom_point() +
  geom_smooth(method = "lm") + 
  labs(x = "observed temperature", y = "forecasted temperature") +
  theme_bw()


```

```{r sunp-depth, eval=F}
# depth plot
depth_scores <- arrow::open_dataset(s3_score) |> 
  filter(variable == "depth",
         site_id %in% c("sunp"),
         reference_datetime == most_recent) |> 
  dplyr::collect()

plot_depth(depth_scores) 
```

```{r sunp-mixing}
# chance of being mixed
temperature_forecast <- arrow::open_dataset(s3_forecast) |> 
  filter(variable == "temperature",
         site_id %in% c("sunp"),
         reference_datetime == most_recent) |> 
  dplyr::collect()%>%
  na.omit(prediction)

plot_mixing(forecast_df = temperature_forecast, eval_depths = c(1, 8), use_density = T, threshold = 0.1)

```

```{r sunp-ice}
# Ice plot
ice_forecasts <- arrow::open_dataset(s3_forecast) |> 
  filter(variable == "ice_thickness",
         site_id %in% c("sunp"),
         reference_datetime == most_recent) |> 
  dplyr::collect()

plot_ice(ice_forecasts)
```

:::
