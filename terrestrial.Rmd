---
title: "NEON4CAST Dashboard"
output:
  flexdashboard::flex_dashboard:
    storyboard: true
    theme: 
      version: 4
      bootswatch: lux
    source_code: "https://github.com/eco4cast/neon4cast-dashboard"
    navbar:
    - { title: "Phenology", icon: "fas fa-leaf", href: "phenology", target: "_blank"}
    - { title: "Aquatics", icon: "fa fa-tint", href: "aquatics", target: "_blank"}
    - { title: "Terrestrial", icon: "fa fa-thermometer-4", href: "terrestrial", target: "_blank"}
    - { title: "Ticks", icon: "fa fa-search", href: "ticks", target: "_blank"}
    - { title: "Beetles", icon: "fas fa-bug", href: "beetles", target: "_blank"}    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=FALSE)
library(flexdashboard)
library(thematic)
library(ggiraph)
library(patchwork)
library(tidyverse)
library(DT)
thematic::thematic_rmd()
```

```{r include=FALSE, cache=TRUE}
source("R/combined_scores.R")
combined <- combined_scores("terrestrial_daily")
filled_scores <- fill_scores(combined)
```


```{r}

leaderboard <-  filled_scores %>% 
  group_by(target, team) %>%
  summarise(crps = mean(crps),
            logs = mean(logs),
            percent_na = mean(is.na(crps_team))) %>% 
  arrange(crps)
#leaderboard %>% DT::datatable(fillContainer = FALSE, escape=FALSE)
```
```{r}
by_start <-  filled_scores %>% 
  group_by(target, team, forecast_start_time, site) %>%
  summarise(crps = mean(crps),
            logs = mean(logs),
            percent_na = mean(is.na(crps_team))) %>% 
  arrange(crps)
```


## Row {data-height=650 }

### `nee` Daily


```{r}
board1 <- 
leaderboard %>% 
  filter(target == "nee") %>%
  pivot_longer(cols = c(crps, logs), names_to="metric", values_to="score") %>%
  ggplot(aes(team, score, fill=team, col=team)) + 
  geom_col_interactive(aes(tooltip = team, data_id = team), show.legend = FALSE) + 
  facet_wrap(~metric, scales = "free_y") + 
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank()) + 
  ggtitle("nee forecasts")
```



```{r}
board2 <- 
  by_start %>% 
  filter(target == "nee")  %>% 
  filter(percent_na < .01) %>%
  ggplot(aes(forecast_start_time, crps, col=team)) + 
    geom_point_interactive(aes(tooltip = team, data_id = team), size=2, show.legend = FALSE) +
    geom_line_interactive(aes(tooltip = team, data_id = team), size=1, show.legend = FALSE) + 
  facet_wrap(~site)
```


```{r girafe, fig.width=8, fig.height=5}
ggob <- board1 / board2 # patchwork stack
girafe(ggobj = ggob,
       width_svg = 8, height_svg = 5,
  options = list(
    opts_hover_inv(css = "opacity:0.20;"),
    opts_hover(css = "stroke-width:2;"),
    opts_zoom(max = 4)
  ))
```

***


Overall team rankings by forecast skill, as well as skill by date of initial forecast.


**Top plots**: Forecast skill measured by CRPS and log skill. 
Lower values indicate better predictions. Both score  probabilistic forecasts,
but log skill penalizes observations outside expected range much more heavily.

**Lower plot**: Forecast skill over time at each site. Not all teams submit multiple forecasts.


**Tip**: _Mouse over a color to highlight the scores of one a team_



### `le` Daily


```{r}
board1 <- 
leaderboard %>% 
  filter(target == "le") %>%
  pivot_longer(cols = c(crps, logs), names_to="metric", values_to="score") %>%
  ggplot(aes(team, score, fill=team, col=team)) + 
  geom_col_interactive(aes(tooltip = team, data_id = team), show.legend = FALSE) + 
  facet_wrap(~metric, scales = "free_y") + 
  theme(axis.ticks.x = element_blank(),
        axis.text.x = element_blank()) + 
  ggtitle("nee forecasts")
```



```{r}
board2 <- 
  by_start %>% 
  filter(target == "le")  %>% 
  filter(percent_na < .01) %>%
  ggplot(aes(forecast_start_time, crps, col=team)) + 
    geom_point_interactive(aes(tooltip = team, data_id = team), size=2, show.legend = FALSE) +
    geom_line_interactive(aes(tooltip = team, data_id = team), size=1, show.legend = FALSE) + 
  facet_wrap(~site)
```


```{r, fig.width=8, fig.height=4}
ggob <- board1 / board2 # patchwork stack
girafe(ggobj = ggob,
       width_svg = 8, height_svg = 4,
  options = list(
    opts_hover_inv(css = "opacity:0.20;"),
    opts_hover(css = "stroke-width:2;"),
    opts_zoom(max = 4)
  ))
```

***


Overall team rankings by forecast skill, as well as skill by date of initial forecast.


**Top plots**: Forecast skill measured by CRPS and log skill. 
Lower values indicate better predictions. Both score  probabilistic forecasts,
but log skill penalizes observations outside expected range much more heavily.

**Lower plot**: Forecast skill over time at each site. Not all teams submit multiple forecasts.


**Tip**: _Mouse over a color to highlight the scores of one a team_





