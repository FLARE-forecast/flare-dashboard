---
title: "Western Virginia Water Authority"
---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

```{r setup}
library(ggiraph)
library(patchwork)
library(tidyverse)
library(neon4cast)
library(score4cast)


library(thematic)
thematic_rmd(bg="white", fg="black", accent="blue")

#source("R/plot-utils.R")


```


```{r include=FALSE}

```

## Most recent forecasts

Below are forecasts for three reservoirs managed by the Western Virginia Water Authority (WVWA). The WVWA is the primary supplier of drinking water to the Roanoke, VA region.

::: panel-tabset
## Falling Creek Reservoir

```{r}
s3 <- arrow::s3_bucket(bucket = "scores/parquet", endpoint_override = "s3.flare-forecast.org", anonymous = TRUE)

most_recent <-  arrow::open_dataset(s3) |> 
  filter(site_id == "fcre") |> 
  distinct(reference_datetime) |>
  collect() |> 
  summarize(max = max(reference_datetime)) 

df_insitu_scores <- arrow::open_dataset(s3) |> 
  filter(variable == "temperature",
         depth %in% c(1.0, 8.0),
         site_id == "fcre",
         reference_datetime == most_recent$max) |> 
 dplyr::collect()
```

The most recent forecast is from `r lubridate::with_tz(lubridate::as_datetime(most_recent$max), tzone = "America/New_York")` (Eastern U.S. time).

```{r}
## date of each team's most recent forecast
my_breaks <- lubridate::with_tz(seq(min(df_insitu_scores$datetime), max(df_insitu_scores$datetime), by = "1 day"),"America/New_York")   
my_label <- seq(lubridate::as_datetime(df_insitu_scores$reference_datetime)[1], max(df_insitu_scores$datetime), by = "5 days")
my_labels <- as.character(my_breaks)
my_labels[which(!(my_breaks %in% my_label))] <- " "

y_label <- expression(paste('Water temprature (',degree,'C)', sep = ""))
df_insitu_scores |> 
  dplyr::mutate(datetime = lubridate::with_tz(lubridate::as_datetime(datetime), "America/New_York"),
                reference_datetime = lubridate::with_tz(lubridate::as_datetime(reference_datetime), "America/New_York"),
                depth = paste0("Depth: ", depth)) |> 
  ggplot(aes(x = datetime)) +
  geom_ribbon(aes(ymin = quantile10, ymax = quantile90), fill = "lightblue", color = "lightblue") +
  geom_line(aes(y = mean)) +
  geom_point(aes(y = observation)) +
  geom_vline(aes(xintercept = reference_datetime)) +
  scale_x_continuous(breaks = my_breaks, labels = my_labels) +
  facet_wrap(~depth) +
  labs(y = y_label) +
  ylim(c(-5,35)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.2)) +
  theme(text = element_text(size = 20))  
```



```{r eval = FALSE}

#Past Performance
df <- arrow::open_dataset(s3) |> 
  filter(variable == "temperature",
         depth %in% c(1.0),
         site_id == "fcre") |> 
  dplyr::collect() 

bounds <- range(c(df$observation, df$mean), na.rm = TRUE)
  
  df |> 
  filter(horizon > 0) |> 
  ggplot(aes(x = observation, y = mean, color = factor(horizon))) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ylim(bounds) +
  xlim(bounds) +
  labs(x = "observed", y = "predicted") +
  theme_bw()

```



```{r eval = FALSE}
#Compare forecasts
s3 <- arrow::s3_bucket(bucket = "forecasts/parquet", endpoint_override = "s3.flare-forecast.org", anonymous = TRUE)

full_forecast <- arrow::open_dataset(s3) |> 
  filter(site_id == "fcre") |> 
  distinct(reference_datetime) |> 
  collect() |> 
  filter(lubridate::as_date(reference_datetime) >= Sys.Date() - lubridate::days(16)) |> 
  summarize(min = min(reference_datetime)) |> 
  pull(min)

df_insitu_forecast <- arrow::open_dataset(s3) |> 
  filter(variable == "temperature",
         depth == 1.0,
         reference_datetime == full_forecast,
         site_id == "fcre") |> 
  select(site_id, reference_datetime, datetime, family, parameter, variable, prediction) |> 
  dplyr::collect()  |> 
  mutate(reference_datetime = lubridate::as_datetime(reference_datetime),
         datetime = lubridate::as_datetime(datetime))
  

noaa_date <- as.character(lubridate::as_date(df_insitu_forecast$reference_datetime)[1])
s3 <- arrow::s3_bucket(bucket = "drivers/noaa/gefs-v12/stage2/parquet/0", endpoint_override = "s3.flare-forecast.org", anonymous = TRUE)
noaa_df <- arrow::open_dataset(s3, partitioning = "reference_date") |> 
  filter(variable == "air_temperature",
         reference_date == noaa_date,
         horizon <= 16 * 24, 
         site_id %in% c("fcre")) |> 
  select(site_id, reference_datetime, datetime, family, parameter, variable, prediction) |> 
  dplyr::collect() |> 
  mutate(prediction = prediction - 273.15)

  

s3 <- arrow::s3_bucket(bucket = "drivers/inflow/fcre_v2/parquet", endpoint_override = "s3.flare-forecast.org", anonymous = TRUE)
inflow_df <- arrow::open_dataset(s3, partitioning = c("model_id","site_id","cycle","reference_date")) |> 
  filter(reference_date == noaa_date,
         cycle == 0,
         flow_type == "inflow",
         variable %in% c("TEMP")) |> 
  select(site_id, reference_datetime, datetime, family, parameter, variable, prediction) |> 
  collect() |> 
  mutate(reference_datetime = lubridate::as_datetime(reference_datetime),
         datetime = lubridate::as_datetime(datetime),
         variable = ifelse(variable == "TEMP","inflow_temperature",variable))

combined <- bind_rows(df_insitu_forecast, noaa_df, inflow_df)
```

```{r eval = FALSE}
insitu_target_file <- "https://s3.flare-forecast.org/targets/fcre_v2/fcre/fcre-targets-insitu.csv"
met_targets_file <- "https://s3.flare-forecast.org/targets/fcre_v2/fcre/observed-met_fcre.csv"
inflow_targets_file <- "https://s3.flare-forecast.org/targets/fcre_v2/fcre/fcre-targets-inflow.csv"

insitu_target <- readr::read_csv(insitu_target_file, show_col_types = FALSE) |>
  filter(depth == 1.0) |> 
  #dplyr::mutate(site_id = paste0(site_id,"-",depth)) |> 
  select(-depth)

met_targets <- readr::read_csv(met_targets_file, show_col_types = FALSE) |> 
  filter(variable == "air_temperature") |> 
  mutate(observation = observation - 273.15)


inflow_targets <- readr::read_csv(inflow_targets_file, show_col_types = FALSE) |> 
  filter(variable == "TEMP") |> 
  mutate(variable = ifelse(variable == "TEMP", "inflow_temperature", variable)) |> 
  mutate(datetime = lubridate::as_datetime(datetime))

target <- bind_rows(insitu_target, met_targets, inflow_targets)

df2 <- combined %>%
  score4cast::standardize_forecast() %>%
  mutate(family = as.character(family)) |> 
  score4cast::crps_logs_score(target) %>%
  mutate(horizon = datetime-lubridate::as_datetime(reference_datetime)) %>%
  mutate(horizon = as.numeric(lubridate::as.duration(horizon),
                              units = "seconds"),
         horizon = horizon / 86400)  |> 
  mutate(variable = ifelse(variable == "temperature", "lake_temperature", variable))
```



```{r eval = FALSE}
#Analyze weather, inflow, and lake forecasts
df2 |> 
  dplyr::filter(horizon > 0) |> 
  ggplot(aes(x = datetime)) +
  geom_ribbon(aes(ymin = quantile10, ymax = quantile90), fill = "lightblue", color = "lightblue") +
  #geom_line(aes(y = mean)) +
  geom_point(aes(y = observation)) +
  facet_wrap(~variable, scale = "free") +
  labs(y = "value") +
  theme_bw()

```

## Beaver Dam Reservoir

```{r}
s3 <- arrow::s3_bucket(bucket = "scores/parquet", endpoint_override = "s3.flare-forecast.org", anonymous = TRUE)

most_recent <-  arrow::open_dataset(s3) |> 
  filter(site_id == "bvre") |> 
  distinct(reference_datetime) |>
  collect() |> 
  summarize(max = max(reference_datetime)) 

df_insitu_scores <- arrow::open_dataset(s3) |> 
  filter(variable == "temperature",
         depth %in% c(1.0, 8.0),
         site_id == "bvre",
         reference_datetime == most_recent$max) |> 
  dplyr::collect()

```

The most recent forecast is from `r lubridate::with_tz(lubridate::as_datetime(most_recent$max), tzone = "America/New_York")` (Eastern U.S. time).

```{r}

my_breaks <- lubridate::with_tz(seq(min(df_insitu_scores$datetime), max(df_insitu_scores$datetime), by = "1 day"),"America/New_York")   
my_label <- seq(lubridate::as_datetime(df_insitu_scores$reference_datetime)[1], max(df_insitu_scores$datetime), by = "5 days")
my_labels <- as.character(my_breaks)
my_labels[which(!(my_breaks %in% my_label))] <- " "

y_label <- expression(paste('Water temprature (',degree,'C)', sep = ""))
df_insitu_scores |> 
  dplyr::mutate(datetime = lubridate::with_tz(lubridate::as_datetime(datetime), "America/New_York"),
                reference_datetime = lubridate::with_tz(lubridate::as_datetime(reference_datetime), "America/New_York"),
                depth = paste0("Depth: ", depth)) |> 
  ggplot(aes(x = datetime)) +
  geom_ribbon(aes(ymin = quantile10, ymax = quantile90), fill = "lightblue", color = "lightblue") +
  geom_line(aes(y = mean)) +
  geom_point(aes(y = observation)) +
  geom_vline(aes(xintercept = reference_datetime)) +
  scale_x_continuous(breaks = my_breaks, labels = my_labels) +
  facet_wrap(~depth) +
  labs(y = y_label) +
  ylim(c(-5,35)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=0.2)) +
  theme(text = element_text(size = 20))  
```

```{r eval = FALSE}
df <- arrow::open_dataset(s3) |> 
  filter(variable == "temperature",
         depth %in% c(1.0),
         site_id == "bvre") |> 
  dplyr::collect() 

bounds <- range(c(df$observation, df$mean), na.rm = TRUE)
  
  df |> 
  filter(horizon > 0) |> 
  ggplot(aes(x = observation, y = mean, color = factor(horizon))) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  ylim(bounds) +
  xlim(bounds) +
  labs(x = "observed", y = "predicted") +
  theme_bw()
```

## Carvins Cove Reservoir

Pending

:::
