---
title: "NEON4CAST Dashboard"
output:
  flexdashboard::flex_dashboard:
    vertical_layout: scroll
    theme: 
      version: 4
      bootswatch: lux
    source_code: "https://github.com/eco4cast/neon4cast-dashboard"
    navbar:
    - { title: "Phenology", icon: "fas fa-leaf", href: "phenology", target: "_blank"}
    - { title: "Aquatics", icon: "fa fa-tint", href: "aquatics", target: "_blank"}
    - { title: "Terrestrial", icon: "fa fa-thermometer-4", href: "terrestrial", target: "_blank"}
    - { title: "Ticks", icon: "fa fa-search", href: "ticks", target: "_blank"}
    - { title: "Beetles", icon: "fas fa-bug", href: "beetles", target: "_blank"}    
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache=FALSE)
library(flexdashboard)
library(thematic)
library(ggiraph)
library(patchwork)
library(tidyverse)
library(neon4cast)
library(lubridate)
library(tools)
library(phenopix)
library(zoo)
thematic::thematic_rmd()
```

```{r include=FALSE}
#combined <- read_csv("https://data.ecoforecast.org/analysis/combined_forecasts_scores.csv.gz")
source("R/combined_scores.R")
combined <- combined_scores("phenology")
```

<!-- Heading 1: navbar -->



```{r}
sites <- c("BART", "CLBJ", "DELA", "GRSM", "HARV", "SCBI", "STEI", "UKFS")

greenness_forecasts <-
  combined %>%
  #filter(siteID %in% sites[-2]) %>%
  filter(theme == "phenology", target == "gcc_90",
         horizon > 30, time > as_date("2021-01-01"), time < (Sys.Date() + days(35))) %>% 
  group_by(time, siteID, team) %>%
  slice_min(horizon) %>% 
  ggplot() +
  geom_point(aes(time, observed), size = .05) + 
  geom_ribbon_interactive(aes(x = time, ymin = lower95, ymax = upper95,
                              fill = team, data_id = team, tooltip = team),
                          alpha = 0.2, show.legend=FALSE) +
  geom_line_interactive(aes(time, mean, col = team, 
                            tooltip = team, data_id = team), show.legend=FALSE) +
  labs(y = "greenness index (gcc 90)") +
  facet_wrap(~siteID, ncol=2) + 
  theme(axis.text.x = element_text( angle = 90, hjust = 0.5, vjust = 0.5)) +
  ggtitle("30th day ahead or longer prediction") 
```



### Greenness {data-height=2000 data.width=500}

Mouse over a trajectory to focus on a team. 
Activate zoom/pan with magnifying glass and then use mouse scroll to zoom.

```{r girafe, fig.width = 10, fig.height = 7.5}
ggob <- greenness_forecasts +
  (score_total) / 
  (score_by_horizon) /
  (score_by_time)
girafe(ggobj = ggob, width_svg = 10, height_svg = 7.5,
  options = list(
    opts_hover_inv(css = "opacity:0.03;"),
    opts_hover(css = "stroke-width:1;"),
    opts_zoom(max = 4)
  ))
```

