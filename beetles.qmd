---
title: "Beetles"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

```{r}
library(ggiraph)
library(patchwork)
library(tidyverse)
library(neon4cast)
library(score4cast)
library(thematic)
thematic_rmd(bg="white", fg="black", accent="blue")

source("R/plot-utils.R")


```

```{r include=FALSE, cache=TRUE}
combined <- combined_scores("beetles")
```


## Most recent forecasts

```{r}
min_data <- 5
day <- combined |>
  filter(!is.na(observed)) |>
  count(target_id, variable, model_id, start_time, site_id) |>
#  filter(n >= min_data) |> 
  filter(start_time == max(start_time)) |> # must happen second
  select(start_time) |> distinct(start_time) |> first()

combined |>
  filter(!is.na(observed)) |> count(model_id)
```


Below is the latest forecasts for which we have at least `r min_data` observations. Mouse over to see the team id, scroll to zoom.  Note that due to latency of data collection for ticks, 'forecasts' lag considerably behind current dates.



::: {.panel-tabset}


## richness

```{r}
combined |> 
  filter(start_time == day, variable == "richness") |> 
  forecast_plots()
```

## abundance

```{r}
combined |> 
  filter(start_time == day, variable == "abundance") |> 
  forecast_plots() 
```


:::






```{r}
filled_scores <- fill_scores(combined, "EFI_avg_null")
```

## Leaderboard

```{r}

leaderboard <-  filled_scores %>% 
  group_by(variable, model_id) %>%
  summarise(crps = mean(crps),
            logs = mean(logs, na.rm=TRUE)) %>% 
  arrange(crps)
leaderboard %>% DT::datatable(fillContainer = FALSE, escape=FALSE)
```




::: {.panel-tabset}


## richness

```{r}
#leaderboard_plots(leaderboard, NULL, "richness")

```

## abundance

```{r}
#leaderboard_plots(leaderboard, NULL, "abundance")
```


:::
<!-- Consider adding site-by-site breakout on scores -->



